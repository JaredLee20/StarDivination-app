<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星宿演禽占卜</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #8b4513;
            --secondary-color: #d4a76a;
            --background-color: #f8f4e9;
            --card-bg: rgba(255, 253, 247, 0.95);
            --element-wood: #4CAF50;
            --element-fire: #f44336;
            --element-earth: #9e9e24;
            --element-metal: #607d8b;
            --element-water: #2196F3;
            --element-sun: #FF9800;
            --element-moon: #9C27B0;
        }
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--background-color);
            background-image: 
                linear-gradient(rgba(255, 253, 245, 0.8), rgba(255, 253, 245, 0.8)),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none"/><path d="M20,20 Q40,5 50,20 Q60,5 80,20 Q95,40 80,50 Q95,60 80,80 Q60,95 50,80 Q40,95 20,80 Q5,60 20,50 Q5,40 20,20Z" fill="none" stroke="%23d4c0a0" stroke-width="0.5" stroke-opacity="0.15"/></svg>');
            color: #5a3825;
            line-height: 1.8;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--secondary-color);
            border-radius: 10px;
            padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: normal;
            color: var(--primary-color);
            margin: 0 0 30px;
            font-family: 'Ma Shan Zheng', cursive;
            letter-spacing: 3px;
            position: relative;
            padding-bottom: 20px;
        }
        
        h1:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 30%;
            right: 30%;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--secondary-color), transparent);
            border-radius: 50%;
        }
        
        .form-container {
            background: rgba(237, 235, 220, 0.7);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid var(--secondary-color);
            text-align: center;
        }
        
        .input-row {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .input-group {
            text-align: center;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #5d4037;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            font-size: 1.1rem;
            text-align: center;
            background: #fffaf0;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        }
        
        .examples {
            margin: 20px 0;
            font-size: 0.95rem;
        }
        
        .char-examples {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .char-example {
            display: inline-block;
            padding: 8px 15px;
            border: 1px solid var(--secondary-color);
            border-radius: 30px;
            background: #fffaf0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }
        
        .char-example:hover {
            background: #ffecb3;
            transform: translateY(-3px);
        }
        
        button {
            background: linear-gradient(to bottom, var(--primary-color), #6b3010);
            color: #ffecb3;
            padding: 14px 35px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            margin: 15px auto 5px;
            display: block;
            font-family: 'Ma Shan Zheng', cursive;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }
        
        button:after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }
        
        button:hover:after {
            left: 100%;
        }
        
        .time-info {
            background: linear-gradient(to right, var(--primary-color), #6b3010);
            color: #ffecb3;
            padding: 14px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1rem;
            border: 1px solid var(--secondary-color);
        }
        
        .result-container {
            padding: 25px;
            background: rgba(233, 224, 209, 0.7);
            border: 1px solid var(--secondary-color);
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .char-analysis {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 4px solid #c0a080;
        }
        
        .char-analysis h3 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .char-strokes {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .stroke {
            padding: 12px;
            background: #fffaf0;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            min-width: 70px;
            text-align: center;
            position: relative;
        }
        
        .stroke:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }
        
        .stroke-element {
            font-weight: bold;
            margin-top: 8px;
            font-size: 1rem;
        }
        
        .card-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .card {
            padding: 20px;
            border: 1px solid var(--secondary-color);
            border-radius: 10px;
            background: #faf7f0;
            text-align: center;
            min-width: 240px;
            flex: 1;
        }
        
        .card h3 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .relation-container {
            text-align: center;
            margin: 25px 0;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .element-box {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 30px;
            margin: 0 8px;
            font-weight: bold;
            color: white;
            min-width: 50px;
            font-size: 1.1rem;
        }
        
        .element-wood { background: var(--element-wood); }
        .element-fire { background: var(--element-fire); }
        .element-earth { background: var(--element-earth); }
        .element-metal { background: var(--element-metal); }
        .element-water { background: var(--element-water); }
        .element-sun { background: var(--element-sun); }
        .element-moon { background: var(--element-moon); }
        
        .process-container {
            margin: 25px 0;
        }
        
        .process-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.4rem;
        }
        
        .stars-sequence {
            background: #fff8e1;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
            text-align: center;
            font-size: 1.1rem;
        }
        
        .final-result {
            font-size: 1.8rem;
            color: #b71c1c;
            font-weight: bold;
            text-align: center;
            margin: 25px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(255, 236, 179, 0.5);
            border: 2px solid var(--secondary-color);
            font-family: 'Ma Shan Zheng', cursive;
        }
        
        .explanation {
            font-size: 1.1rem;
            padding: 20px;
            line-height: 1.8;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #c0a080;
        }
        
        .reminder {
            background: rgba(255, 244, 229, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.95rem;
            border-left: 3px solid var(--element-sun);
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
            margin-top: 30px;
            font-style: italic;
            border-top: 1px solid var(--secondary-color);
            font-size: 0.95rem;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid rgba(139, 69, 19, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .input-row {
                flex-direction: column;
                align-items: center;
            }
            
            .input-group {
                max-width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .char-strokes {
                gap: 10px;
            }
            
            .stroke {
                min-width: 60px;
                padding: 10px;
            }
            
            button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>星宿演禽占卜</h1>
        
        <div class="form-container">
            <div class="input-row">
                <div class="input-group">
                    <label for="number">输入数字 (1-28)</label>
                    <input type="number" id="number" min="1" max="999" value="7">
                </div>
                
                <div class="input-group">
                    <label for="character">输入一个汉字</label>
                    <input type="text" id="character" maxlength="1" value="明">
                </div>
            </div>
            
            <div class="examples">
                <p>常用汉字示例：</p>
                <div class="char-examples">
                    <span class="char-example" onclick="setChar('明')">明</span>
                    <span class="char-example" onclick="setChar('清')">清</span>
                    <span class="char-example" onclick="setChar('炎')">炎</span>
                    <span class="char-example" onclick="setChar('日')">日</span>
                    <span class="char-example" onclick="setChar('月')">月</span>
                    <span class="char-example" onclick="setChar('林')">林</span>
                    <span class="char-example" onclick="setChar('鑫')">鑫</span>
                    <span class="char-example" onclick="setChar('淼')">淼</span>
                </div>
            </div>
            
            <button onclick="performDivination()">开始占卜</button>
        </div>
        
        <div class="time-info">
            当前时间: <span id="current-time"></span> | 
            干支日期: <span id="ganzhi-date"></span> | 
            月行属性: <span id="month-element" class="element-box element-fire">火</span> | 
            日气属性: <span id="day-element" class="element-box element-wood">木</span>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>星宿演算中...</p>
        </div>
        
        <div class="result-container" id="result-container">
            <div class="char-analysis">
                <h3>汉字 <span id="current-char">明</span> 结构分析</h3>
                <p id="char-structure">日 (日属性) + 月 (月属性)</p>
                
                <div class="char-strokes" id="strokes-container">
                    <!-- 动态生成的笔画信息 -->
                </div>
                
                <div class="reminder">
                    拆分提示: 本系统优先识别偏旁部首，然后对剩余字形进行笔画分解。
                    如"清"字拆为氵(水)后，对"青"部分继续分解为笔画属性。
                </div>
            </div>
            
            <div class="card-container">
                <div class="card">
                    <h3>先天星宿</h3>
                    <p id="first-star">箕水豹</p>
                    <p id="first-element">五行: <span class="element-box element-water">水</span></p>
                </div>
                
                <div class="card">
                    <h3>后天主星</h3>
                    <p id="last-star">心月狐</p>
                    <p id="last-element">五行: <span class="element-box element-moon">月</span></p>
                </div>
            </div>
            
            <div class="relation-container">
                先天星宿 <span id="relation" class="element-box element-water">水 → 月</span> 后天主星
            </div>
            
            <div class="process-container">
                <h3>✨ 流星过程 ✨</h3>
                <div class="stars-sequence" id="process">
                    (日) 虚日鼠 <span class="element-box element-sun">日</span> → (月) 心月狐 <span class="element-box element-moon">月</span>
                </div>
            </div>
            
            <div class="final-result">占卜结果: <span id="judgment">中吉</span></div>
            <div class="explanation" id="explanation">
                先天遇后天，五行比和之象，主和谐顺利。所求之事可得助力，诸事平顺，宜把握时机进取。
            </div>
        </div>
        
        <footer>
            <p>星宿演禽秘法 | 天文历法数术传承 | 心诚则灵</p>
        </footer>
    </div>

    <script>
        // 更新当前时间显示
        function updateDateTimeDisplay() {
            const now = new Date();
            const formattedTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = formattedTime;
            setTimeout(updateDateTimeDisplay, 1000);
        }
        
        // 设置汉字快捷输入
        function setChar(char) {
            document.getElementById('character').value = char;
            document.getElementById('current-char').textContent = char;
            document.querySelector('#result-container').style.display = 'none';
        }
        
        // 显示加载状态
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.querySelector('#result-container').style.display = 'none';
        }
        
        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.querySelector('#result-container').style.display = 'block';
        }
        
        // 初始化显示
        updateDateTimeDisplay();
        document.getElementById('ganzhi-date').textContent = "乙巳年 壬午月 乙亥日";
        
        // 二十八星宿列表
        const stars = [
            "角木蛟", "亢金龙", "氐土貉", "房日兔", "心月狐", "尾火虎", "箕水豹",
            "斗木獬", "牛金牛", "女土蝠", "虚日鼠", "危月燕", "室火猪", "壁水獝",
            "奎木狼", "娄金狗", "胃土雉", "昴日鸡", "毕月乌", "觜火猴", "参水猿",
            "井木犴", "鬼金羊", "柳土獐", "星日马", "张月鹿", "翼火蛇", "轸水蚓"
        ];
        
        // 特殊字形映射 - 按照文档精确对应
        const specialComponents = {
            // 日属性
            "日": { element: "日", meaning: "日属性（整体字）" },
            "曰": { element: "日", meaning: "曰字旁属日" },
            "耳": { element: "日", meaning: "耳字旁属日" },
            "目": { element: "日", meaning: "目字旁属日" },
            "甘": { element: "日", meaning: "甘字底属日" },
            "三": { element: "日", meaning: "三字属日" },
            
            // 月属性
            "月": { element: "月", meaning: "月属性（整体字）" },
            "舟": { element: "月", meaning: "舟字底属月" },
            
            // 土属性
            "土": { element: "土", meaning: "土字属土" },
            "一": { element: "土", meaning: "横笔属土" },
            "二": { element: "土", meaning: "二字属土" },
            
            // 火属性
            "火": { element: "火", meaning: "火字属火" },
            "灬": { element: "火", meaning: "四点底属火" },
            "乀": { element: "火", meaning: "捺笔属火" },
            
            // 金属性
            "金": { element: "金", meaning: "金字属金" },
            "钅": { element: "金", meaning: "金字旁属金" },
            "丿": { element: "金", meaning: "撇笔属金" },
            "提": { element: "金", meaning: "提笔属金" },
            "横撇": { element: "金", meaning: "横撇属金" },
            "撇折": { element: "金", meaning: "撇折属金" },
            "厶": { element: "金", meaning: "厶字属金" },
            
            // 木属性 (已移除尸字头)
            "木": { element: "木", meaning: "木字属木" },
            "丁": { element: "木", meaning: "丁字属木" },
            "人": { element: "木", meaning: "人字属木" },
            "丨": { element: "木", meaning: "竖笔属木" },
            "亅": { element: "木", meaning: "竖钩属木" },
            "乛": { element: "木", meaning: "横折属木" },
            "㇆": { element: "木", meaning: "横折钩属木" },
            "㇉": { element: "木", meaning: "竖折折钩属木" },
            "𠃍": { element: "木", meaning: "横折属木" },
            "𡿨": { element: "木", meaning: "竖折属木" },
            "𠃋": { element: "木", meaning: "撇折属木" },
            "𠃊": { element: "木", meaning: "竖折折属木" },
            "巛": { element: "木", meaning: "三拐属木" },
            "刂": { element: "木", meaning: "立刀旁属木" },
            
            // 水属性
            "水": { element: "水", meaning: "水字属水" },
            "口": { element: "水", meaning: "口字属水" },
            "之": { element: "水", meaning: "之字属水" },
            "丶": { element: "水", meaning: "点笔属水" },
            "氵": { element: "水", meaning: "三点水属水" },
            "冫": { element: "水", meaning: "两点水属水" },
            "⺡": { element: "水", meaning: "水字底属水" }
        };
        
        // 笔画属性映射 - 精确对应文档
        function strokeToElement(strokeName) {
            // 首先检查是否为特殊笔画名称
            if (specialComponents[strokeName]) {
                return specialComponents[strokeName];
            }
            
            // 通用笔画属性映射
            switch(strokeName) {
                case "横": 
                case "提":
                    return { element: "土", meaning: "横笔属土" };
                case "竖":
                case "竖钩":
                case "弯钩":
                case "斜钩":
                case "卧钩":
                case "横折弯钩":
                case "横斜钩":
                case "竖折折钩":
                case "横折":
                case "竖折":
                case "竖弯":
                case "横折折":
                case "竖折折":
                case "横折折折":
                    return { element: "木", meaning: "竖及折笔属木" };
                case "撇":
                case "横撇":
                case "撇折":
                    return { element: "金", meaning: "撇及相关笔形属金" };
                case "捺":
                    return { element: "火", meaning: "捺笔属火" };
                case "点":
                    return { element: "水", meaning: "点笔属水" };
                default: 
                    return { element: "土", meaning: "其他笔形默认属土" };
            }
        }
        
        // 优先处理的偏旁部首
        const radicalComponents = [
            "氵", "灬", "钅", "冫", "日", "月", "艹", "扌", "亻", 
            "木", "火", "土", "金", "水", "石", "鱼", "鸟", "虫"
        ];
        
        // 汉字笔画数据库
        const charStrokesDB = {
            "明": ["日", "月"],
            "清": ["氵", "青"],
            "炎": ["火", "火"],
            "林": ["木", "木"],
            "晶": ["日", "日", "日"],
            "江": ["氵", "工"],
            "燃": ["火", "然"],
            "鑫": ["金", "金", "金"],
            "淼": ["水", "水", "水"],
            "森": ["木", "木", "木"],
            "圭": ["土", "土"],
            "五": ["横", "竖", "横折", "横"],
            "十": ["横", "竖"],
            "水": ["竖钩", "点", "提", "捺"],
            "火": ["点", "撇", "点", "捺"],
            "木": ["横", "竖", "撇", "捺"],
            "王": ["横", "横", "竖", "横"],
            "永": ["点", "横", "竖钩", "点", "提", "撇", "捺"],
            "月": ["月"],
            "日": ["日"],
            "舟": ["舟"],
            "耳": ["耳"],
            "甘": ["甘"],
            "目": ["目"],
            "之": ["点", "横撇", "捺"],
            "道": ["点", "横撇", "捺", "首"],
            "草": ["艹", "早"],
            "竹": ["⺮", "亇"],
            "冰": ["冫", "水"],
            "冬": ["夂", "冫"],
            "钅": ["钅"],
            "吉": ["士", "口"],
            "品": ["口", "口", "口"],
            "休": ["亻", "木"],
            "湖": ["氵", "胡"]
        };
        
        // 智能汉字拆解函数 - 优先拆分偏旁，然后分解剩余部分
        function decomposeCharacter(character) {
            // 1. 检查是否在特殊字形库中
            if (specialComponents[character]) {
                return [character];
            }
            
            // 2. 尝试识别偏旁部首
            for (const radical of radicalComponents) {
                if (character.startsWith(radical)) {
                    const remaining = character.substring(radical.length);
                    return [radical, ...decomposeRemaining(remaining)];
                }
            }
            
            // 3. 检查笔画数据库
            if (charStrokesDB[character]) {
                return charStrokesDB[character];
            }
            
            // 4. 默认拆解为笔画
            return ["横", "竖", "撇", "捺"];
        }
        
        // 分解剩余部分（对非偏旁部分进行分解）
        function decomposeRemaining(remaining) {
            if (remaining.length === 0) return [];
            
            // 尝试识别特殊字形
            if (specialComponents[remaining]) {
                return [remaining];
            }
            
            // 检查是否可以进一步拆分为偏旁
            for (const radical of radicalComponents) {
                if (remaining.startsWith(radical)) {
                    const nextRemaining = remaining.substring(radical.length);
                    return [radical, ...decomposeRemaining(nextRemaining)];
                }
            }
            
            // 尝试拆解为笔画序列
            if (charStrokesDB[remaining]) {
                return charStrokesDB[remaining];
            }
            
            // 无法识别，作为笔画处理
            return [remaining];
        }
        
        // 查找匹配的星宿
        function findMatchingStar(startIndex, element) {
            let currentIndex = (startIndex + 1) % 28;
            const startPosition = currentIndex;
            
            do {
                const star = stars[currentIndex];
                const starElement = getElementFromStar(star);
                
                // 精确匹配逻辑
                if (element === "日" && starElement === "日") return currentIndex;
                if (element === "月" && starElement === "月") return currentIndex;
                if (element === "木" && starElement === "木") return currentIndex;
                if (element === "土" && starElement === "土") return currentIndex;
                if (element === "金" && starElement === "金") return currentIndex;
                if (element === "水" && starElement === "水") return currentIndex;
                if (element === "火" && starElement === "火") return currentIndex;
                
                currentIndex = (currentIndex + 1) % 28;
                
            } while (currentIndex !== startPosition);
            
            return startPosition;
        }
        
        // 从星宿名提取五行属性
        function getElementFromStar(starName) {
            const elementChar = starName.charAt(1);
            switch(elementChar) {
                case '木': return '木';
                case '金': return '金';
                case '土': return '土';
                case '火': return '火';
                case '水': return '水';
                case '日': return '日';
                case '月': return '月';
                default: return '木';
            }
        }
        
        // 获取五行CSS类名
        function getElementClass(element) {
            switch(element) {
                case '木': return 'wood';
                case '火': return 'fire';
                case '土': return 'earth';
                case '金': return 'metal';
                case '水': return 'water';
                case '日': return 'sun';
                case '月': return 'moon';
                default: return 'wood';
            }
        }
        
        // 五行生克关系判断
        function interpretResult(firstElement, lastElement) {
            // 五行生克关系
            const relationships = {
                '木': { overcomes: '土', generatedBy: '水', generates: '火' },
                '火': { overcomes: '金', generatedBy: '木', generates: '土' },
                '土': { overcomes: '水', generatedBy: '火', generates: '金' },
                '金': { overcomes: '木', generatedBy: '土', generates: '水' },
                '水': { overcomes: '火', generatedBy: '金', generates: '木' },
                '日': { overcomes: '月', generatedBy: '木', generates: '土' },
                '月': { overcomes: '日', generatedBy: '水', generates: '金' }
            };
            
            // 判断逻辑
            if (firstElement === lastElement) {
                return {
                    judgment: "中吉",
                    explanation: "先天遇后天，五行比和之象，主和谐顺利。所求之事可得助力，诸事平顺，宜把握时机进取。"
                };
            }
            
            if (relationships[lastElement]?.generatedBy === firstElement) {
                return {
                    judgment: "吉",
                    explanation: "先天生后天，遇星生我之象，主得助益。预示贵人扶持，事多遂意，福禄自至，诸事皆宜。"
                };
            }
            
            if (relationships[lastElement]?.generates === firstElement) {
                return {
                    judgment: "中平",
                    explanation: "后天生先天，我生遇星之象，主付出有报。需亲力亲为，过程劳心但终有所获，宜持恒心以待事成。"
                };
            }
            
            if (relationships[lastElement]?.overcomes === firstElement) {
                return {
                    judgment: "小仇",
                    explanation: "我克遇星之象，主小有阻碍。事有波折但可化解，需谨慎应对，避免强求，以智取胜方为妙。"
                };
            }
            
            return {
                judgment: "凶",
                explanation: "遇星克我，主不利之兆。事多阻碍，易遇竞争困扰，需守不宜攻，谨言慎行，待机而行。"
            };
        }
        
        // 执行占卜
        function performDivination() {
            showLoading();
            
            setTimeout(() => {
                // 获取用户输入
                const number = parseInt(document.getElementById('number').value) || 1;
                const character = document.getElementById('character').value || '明';
                
                // 更新当前显示汉字
                document.getElementById('current-char').textContent = character;
                
                // 1. 确定先天星宿（遇星）
                const firstStarIndex = (number - 1) % 28;
                const firstStar = stars[firstStarIndex];
                const firstElement = getElementFromStar(firstStar);
                
                // 2. 智能拆解汉字
                const components = decomposeCharacter(character);
                
                // 3. 生成笔画分析内容
                const strokesContainer = document.getElementById('strokes-container');
                strokesContainer.innerHTML = '';
                let charStructure = '';
                
                // 4. 生成结构描述
                let structureDesc = '';
                components.forEach((component, index) => {
                    // 确定组件属性
                    let elementData = strokeToElement(component);
                    const elemClass = getElementClass(elementData.element);
                    
                    // 添加到笔画分析
                    strokesContainer.innerHTML += `
                        <div class="stroke">
                            <div style="font-size: 1.8rem">${component}</div>
                            <div class="stroke-element element-box element-${elemClass}">${elementData.element}</div>
                            <div style="font-size: 0.9rem; margin-top: 8px;">${elementData.meaning}</div>
                        </div>
                    `;
                    
                    // 构建结构描述
                    structureDesc += `${component} (${elementData.element})`;
                    if (index < components.length - 1) structureDesc += ' + ';
                });
                
                document.getElementById('char-structure').textContent = structureDesc;
                
                // 5. 生成流星序列
                let currentIndex = firstStarIndex;
                const processStars = [];
                
                for (const component of components) {
                    // 获取当前组件对应的元素
                    let elementData = strokeToElement(component);
                    const element = elementData.element;
                    
                    // 查找匹配星宿
                    currentIndex = findMatchingStar(currentIndex, element);
                    processStars.push({
                        star: stars[currentIndex],
                        element: getElementFromStar(stars[currentIndex]),
                        originalElement: element
                    });
                }
                
                // 6. 确定后天主星
                const lastStar = processStars.length ? processStars[processStars.length-1].star : firstStar;
                const lastElement = getElementFromStar(lastStar);
                
                // 7. 更新显示
                document.getElementById('first-star').textContent = firstStar;
                const firstElemClass = getElementClass(firstElement);
                document.getElementById('first-element').innerHTML = 
                    `五行: <span class="element-box element-${firstElemClass}">${firstElement}</span>`;
                
                document.getElementById('last-star').textContent = lastStar;
                const lastElemClass = getElementClass(lastElement);
                document.getElementById('last-element').innerHTML = 
                    `五行: <span class="element-box element-${lastElemClass}">${lastElement}</span>`;
                
                // 8. 显示流星序列
                let processHTML = "";
                for (let i = 0; i < processStars.length; i++) {
                    const star = processStars[i].star;
                    const element = processStars[i].element;
                    const originalElement = processStars[i].originalElement;
                    const elemClass = getElementClass(element);
                    
                    if (i > 0) processHTML += " → ";
                    processHTML += `(${originalElement}) ${star} <span class="element-box element-${elemClass}">${element}</span>`;
                }
                document.getElementById('process').innerHTML = processHTML;
                
                // 9. 更新关系显示
                const relationEl = document.getElementById('relation');
                relationEl.innerHTML = `${firstElement} → ${lastElement}`;
                relationEl.className = `element-box element-${firstElemClass}`;
                
                // 10. 分析结果
                const result = interpretResult(firstElement, lastElement);
                document.getElementById('judgment').textContent = result.judgment;
                document.getElementById('explanation').textContent = result.explanation;
                
                hideLoading();
            }, 800); // 模拟占卜过程需要时间
        }
        
        // 页面加载后初始化
        window.onload = function() {
            updateDateTimeDisplay();
            document.getElementById('ganzhi-date').textContent = "乙巳年 壬午月 乙亥日";
            
            // 初始占卜
            setTimeout(performDivination, 500);
        };
    </script>
</body>
</html>